---
title: "HTO Report"
author: "Quanhu Sheng"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmdformats::readthedown:
    toc_depth: 3
    code_folding: hide
---

```{r global options, include = FALSE}
knitr::opts_chunk$set(echo=TRUE, include=TRUE, warning=FALSE, message=FALSE)
```

```{css, echo=FALSE}
#content{
    max-width:1920px;
}
```

```{r setup}
library(Seurat)
library(ggplot2)
library(patchwork)
library(kableExtra)
library(dplyr)
library(mclust)

theme_bw3 <- function () { 
	theme_bw() +
	theme(
		strip.background = element_rect(fill = NA, colour = 'black'),
		panel.border = element_rect(fill = NA, color = "black"),			
		axis.line = element_line(colour = "black", size = 0.5)
	)
}

root_dir="C:/projects/scratch/cqs/shengq2/papers/20221116_scrna_hto/"
```

```{r}
prepare_data<-function(name){
  rds_file=paste0(root_dir, name, "/", name, ".results_obj.rds")

  htos<-readRDS(rds_file)

  glist<-list()
  meta<-htos@meta.data

  htocols<-c("scDemultiplex", "HTODemux", "MULTIseqDemux", "GMM_demux")
  col=htocols[1]
  for(col in htocols){
    newcol.global.name<-paste0(col, ".global")
    newcol.global<-as.character(meta[,col])
    newcol.global[!newcol.global %in% c("Negative", "Doublet")]<-"Singlet"
    htos<-AddMetaData(htos, newcol.global, col.name = newcol.global.name)

    glist[[col]] = DimPlot(htos, reduction="umap", group.by=col) + ggtitle(col) 

    celllist<-list()
    celllist$Negative<-colnames(htos)[newcol.global == "Negative"]
    celllist$Doublet<-colnames(htos)[newcol.global == "Doublet"]

    glist[[newcol.global.name]] = DimPlot(htos, reduction="umap", cells.highlight = celllist, group.by=newcol.global.name) + ggtitle(col) + scale_color_manual(labels=c('Singlet', 'Negative', 'Doublet'), values =c("gray", "blue", "red"))

    celllist<-list()
    celllist$Singlet<-colnames(htos)[newcol.global == "Singlet"]

    glist[[paste0(newcol.global.name, "_singlet")]] = DimPlot(htos, reduction="umap", cells.highlight = celllist, group.by=newcol.global.name) + ggtitle(col) + scale_color_manual(labels=c('Other', 'Singlet'), values =c("gray", "blue"))
  }
  
  g<-wrap_plots(glist, ncol=3)
  return(list(htos=htos, htocols=htocols, g=g))
}
```

```{r}
process_data<-function(name){
  cat("##", name, "\n\n")
  hto_list<-prepare_data(name)
  obj<-hto_list$htos
  meta<-obj@meta.data
  meta$log_nCount_HTO<-log2(meta$nCount_HTO + 1)

  cat("### Four HTO demultiplex methods\n\n")
  
  alltb<-NULL
  for (col in hto_list$htocols){
    coltb<-table(meta[,col])
    if(is.null(alltb)){
      alltb<-rbind(alltb, coltb)
    }else{
      coltb<-coltb[colnames(alltb)]
      alltb<-rbind(alltb, coltb)
    }
  }
  rownames(alltb)<-hto_list$htocols
  tbl<-alltb %>%
    kbl() %>%
    kable_paper("hover", full_width = T)  
  print(tbl)
  write.csv(alltb, paste0(name, ".cell.csv"))
  
  png(paste0(name, ".demulti.png"), width=4000, height=5000, res=300)
  print(hto_list$g)
  dev.off()
  print(hto_list$g)

  cat("### DE analysis\n\n")
  alltb<-NULL
  col<-hto_list$htocols[2]
  for (col in hto_list$htocols){
    #singlet<-colnames(obj)[!(meta[,col] %in% c("Negative", "Doublet"))]
    #subobj<-subset(obj, cells=singlet)
    subobj<-obj
    Idents(subobj)<-col
    markers<-FindAllMarkers(subobj, pseudocount.use = FALSE,only.pos = TRUE)
    markers<-markers[!(markers$cluster %in% c("Negative", "Doublet")),]
    markers<-markers[order(markers$gene),c("gene", "avg_log2FC"), drop=F]
    rownames(markers)<-markers$gene
    markers<-markers[,"avg_log2FC", drop=F]
    colnames(markers)=col
    if(is.null(alltb)){
      alltb<-markers
    }else{
      alltb<-cbind(alltb, markers)
    }
  }
  tbl<-t(alltb) %>%
    kbl() %>%
    kable_paper("hover", full_width = T)  
  print(tbl)
  write.csv(alltb, paste0(name, ".de.csv"))
  
  if(name == "hto12"){
    hto12_combined_obj_rds<-paste0(root_dir, "/hto12/hto12.combined.rds")
    expobj<-readRDS(hto12_combined_obj_rds)
    expobj<-expobj[,colnames(obj)]
    ari_list=list()
    col=hto_list$htocols[1]
    for(col in hto_list$htocols){
      ari=adjustedRandIndex(expobj$seurat_clusters, unlist(FetchData(obj, col)))
      ari_list[[col]] = ari
    }
    ari_df<-t(data.frame(ari_list))
    colnames(ari_df)<-"ari"
    cat("\n\n#### AdjustRandIndex\n\n")
    tbl<-ari_df %>%
      kbl() %>%
      kable_paper("hover", full_width = T)  
    print(tbl)
    write.csv(ari_df, paste0(name, ".ari.csv"))

    glist=list()
    newcols=c()
    for(col in hto_list$htocols){
      newcol = paste0(col, "_celltype")
      newcolvalue = gsub("-.", "", unlist(FetchData(obj, col)))
      cts<-sort(unique(newcolvalue))      
      obj<-AddMetaData(obj, newcolvalue, col.name = newcol)
      newcols<-c(newcols, newcol)
      glist[[col]] = DimPlot(obj, reduction = "umap", group.by=newcol) + ggtitle(col)
    }
    
    ct=cts[1]
    for(ct in cts){
      for(col in hto_list$htocols){
        newcol = paste0(col, "_celltype")
        newcolvalue = unlist(FetchData(obj, newcol))
        cells<-colnames(obj)[newcolvalue == ct]
        gname = paste0(col, ":", ct)
        g<-DimPlot(obj, reduction = "umap", cells.highlight = cells, cols.highlight = "red") + ggtitle(gname) + NoLegend()
        glist[[gname]] = g
      }
    }
    
    gg<-wrap_plots(glist, ncol=length(newcols))
    return(gg)
  }else{
    return(NULL)
  }
}
```

```{r results="asis", fig.height=20, fig.width=15}
gg<-process_data("hto12")
```

```{r results="asis", fig.height=28, fig.width=16}
print(gg)
saveRDS(gg, "hto12.gg.rds")
```

```{r results="asis", fig.height=20, fig.width=15}
process_data("pbmc")
```
